<!DOCTYPE html>
<html lang="en">
    <head>
        <title>bearcat-dao 0.2.0 更新日志 - bearcat</title>
        <meta charset="utf-8">
        <meta name="description" content="bearcat - magic, expressive javaScript objects powered world.">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
        <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600|Lato|Inconsolata' rel='stylesheet' type='text/css'>
        <link rel="icon" href="/images/logo.png" type="image/x-icon">
        <script>
            window.PAGE_TYPE = "博客"
        </script>
        <link rel="stylesheet" href="/css/page.css" type="text/css">

        <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', '', 'bearcatjs.org');
  ga('send', 'pageview');
</script>
        <script src="/js/vue.min.js"></script>
        <link rel="stylesheet" href="/css/style.css">
        <link rel="stylesheet" href="/css/highlight.css">
        <!--link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css"-->
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
        <script type="text/javascript">
            hljs.initHighlightingOnLoad();
        </script>
    </head>
    <body>
        <div id="mobile-bar">
            <a class="menu-button"></a>
            <a class="logo" href="/"></a>
        </div>
        
        
            <div id="header">
    <a id="logo" href="/">
        <img src="/images/logo.png">
        <span>bearcat</span>
    </a>
    <ul id="nav">
        <li><a href="/guide/" class="nav-link">Guide</a></li>
<li><a href="/api/" class="nav-link">API Reference</a></li>
<li><a href="/examples/" class="nav-link">Examples</a></li>
<li><a href="/blog/" class="nav-link">Blog</a></li>
<li><a href="/topic/" class="nav-link">Topic</a></li>
<li><a href="https://github.com/bearcatjs/bearcat" target="_blank" class="nav-link">GitHub</a></li>

    </ul>
</div>
        

        <div id="main">
            
                
    <div class="sidebar">
    <ul class="main-menu">
        <li><a href="/guide/" class="nav-link">Guide</a></li>
<li><a href="/api/" class="nav-link">API Reference</a></li>
<li><a href="/examples/" class="nav-link">Examples</a></li>
<li><a href="/blog/" class="nav-link">Blog</a></li>
<li><a href="/topic/" class="nav-link">Topic</a></li>
<li><a href="https://github.com/bearcatjs/bearcat" target="_blank" class="nav-link">GitHub</a></li>

    </ul>
    <div class="list">
        <h2>博客</h2>
        <ul class="menu-root">
            
                <li><a href="/博客/index.html" class="sidebar-link">javaScript 依赖管理</a></li>
            
                <li><a href="/博客/release-0.3.6.html" class="sidebar-link">bearcat 0.3.6 更新日志</a></li>
            
                <li><a href="/博客/release-0.3.14.html" class="sidebar-link">bearcat 0.3.14 更新日志</a></li>
            
                <li><a href="/博客/release-0.4.0.html" class="sidebar-link">bearcat 0.4.0 更新日志</a></li>
            
                <li><a href="/博客/bearcat-dao-release-0.2.0.html" class="sidebar-link current">bearcat-dao 0.2.0 更新日志</a></li>
            
                <li><a href="/博客/bearcat-cocos2djs.html" class="sidebar-link">基于 bearcat 的 cocos2d-js 游戏开发</a></li>
            
                <li><a href="/博客/release-0.4.11.html" class="sidebar-link">bearcat 0.4.11 更新日志</a></li>
            
        </ul>
    </div>
</div>

<div class="content 博客 with-sidebar">
    <h1>bearcat-dao 0.2.0 更新日志</h1>
    <h2 id="概述">概述</h2>
<p><a href="https://github.com/bearcatjs/bearcat-dao" target="_blank" rel="external">bearcat-dao</a> 是一个 node.js 基于 SQL mapping 的 DAO 框架。实现了基于 SQL mapping 来对数据结果集进行映射，是一种半自动化的模式，相比较于 O/R mapping 全自动化的模式。 因此，在 bearcat-dao 里，开发者能够对SQL进行完全的控制，通过SQL来与数据库打交道并进行性能优化，bearcat-dao 则会把数据结果集映射到 <a href="http://bearcatjs.org/guide/model.html" target="_blank" rel="external">bearcat model</a> 中去。  </p>
<h2 id="SQL_mapping_vs_O/R_mapping">SQL mapping vs O/R mapping</h2>
<p>结构化查询语言（SQL）已经存在了非常久的时间。自从 Edgar F.Codd 第一次提出“数据可以被规范化为一组相互关联的表”这样的思想以来，已经超过35年了。很少有哪一种软件技术敢声称自己像关系数据库和SQL那样经受住了时间的考验。因此，关系数据库和SQL仍然很有价值，我们可能都曾有这样的经历，应用程序的源代码（经历了很多版本）随着时间的流逝最终还是过时了（无法维护下去），但它的数据库甚至是SQL本身却仍然很有价值。</p>
<p>O/R mapping 被设计为用来简化对象持久化工作的，它通过将SQL完全从开发人员的职责中排除来达到这个目的。在O/R mapping中，SQL是给予应用程序中的类与关系数据库表之间的映射关系而生成的。除了不用写SQL语句，使用O/R mapping的API通常也比典型的SQL API要简单很多，但是O/R mapping仍然不是一颗“银弹”，它并非适用于所有的场景。<br>一个最主要的问题就是O/R mapping它需要假设数据库是被恰当的规范化了，如果没有被恰当规范，这就会给映射带来许多麻烦，甚至需要绕些弯路，或者在设计时对效率做些折衷。同时，没有哪一个对象/关系解决方案可以支持每一种数据库的每一种特性、每一种能力以及设计上固有的缺陷，它们仅仅能做到一个<strong><em>子集</em></strong>，而能做到全集的恰恰则是SQL这个专为数据库设计的结构化查询语言  </p>
<p>SQL mapping 与 O/R mapping 不同，它不是直接把类映射为数据库表或者说把类的字段映射为数据库列，而是把SQL语句与结果（也即输入和输出）映射为类。bearcat-dao 在类（model）和数据库之间建立了一个额外的中间层，这就为如何在类和数据库表之间建立映射关系带来了更大的灵活性，使得在不用改变数据模型或者对象模型的情况下改变它们的映射关系成为可能。这个中间层其实就是SQL，通过SQL可以将类（model）与数据库表之间的关系降到最低。开发者只需要编写SQL，bearcat-dao 负责在类（model）属性与数据库表的列之间映射参数和结果</p>
<h2 id="Model">Model</h2>
<p>model 定义使用 <a href="http://bearcatjs.org/guide/model.html" target="_blank" rel="external">bearcat model</a><br>因此，可以非常容易的就设置映射关系、约束、relation关系  </p>
<p>例如，我们有一个 test 表，它只有一个 id 主键字段  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="operator"><span class="keyword">create</span> <span class="keyword">table</span> test(</span></div><div class="line">    id <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'id'</span>,	</div><div class="line">    </div><div class="line">    <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (id)</div><div class="line">)<span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</div></pre></td></tr></table></figure>

<p>然后，我们可以定义下面的 model  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> TestModel = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">this</span>.$mid = <span class="string">"testModel"</span>;</div><div class="line">    <span class="keyword">this</span>.$table = <span class="string">"test"</span>;</div><div class="line">    <span class="keyword">this</span>.id = <span class="string">"$primary;type:Number"</span>;</div><div class="line">}</div><div class="line">  </div><div class="line"><span class="built_in">module</span>.exports = TestModel;</div></pre></td></tr></table></figure>

<p>在 <strong><em>TestModel</em></strong> 里，我们使用 <strong><em>$table</em></strong> 属性来设置需要映射的表名，对于 <strong><em>id</em></strong> 属性，我们用 <strong><em>primary</em></strong> 表明这是一个主键，并且我们给这个字段添加了一个 <strong><em>type</em></strong> 约束，限定它一定为 Number 类型  </p>
<h2 id="Relation">Relation</h2>
<p>在关系型数据库的表与表之间是可以有 relation 的，也即关系，有一对一、一对多、多对多这三种情况  </p>
<h3 id="一对一_relation">一对一 relation</h3>
<p>一对一关系意味着两张表，一张表有另外一张表的id引用（或者外键）。在model对象里面就是说，两个model，是一对一的  </p>
<p>比如，我们有两张表，<strong><em>test1</em></strong> 表有对 <strong><em>test2</em></strong> 表的 id 引用  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="operator"><span class="keyword">create</span> <span class="keyword">table</span> test1(</span></div><div class="line">    id <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'id'</span>,	</div><div class="line">    rid <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'reference to test2 id'</span>,	</div><div class="line">      </div><div class="line">    <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (id)</div><div class="line">)<span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</div></pre></td></tr></table></figure>



<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="operator"><span class="keyword">create</span> <span class="keyword">table</span> test2(</span></div><div class="line">    id <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'id'</span>,	</div><div class="line">    </div><div class="line">    <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (id)</div><div class="line">)<span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</div></pre></td></tr></table></figure>

<p>然后，我们就可以定义这样的model  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Test1Model = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">this</span>.$mid = <span class="string">"test1Model"</span>;</div><div class="line">    <span class="keyword">this</span>.$table = <span class="string">"test1"</span>;</div><div class="line">    <span class="keyword">this</span>.id = <span class="string">"$primary;type:Number"</span>;</div><div class="line">    <span class="keyword">this</span>.test2 = <span class="string">"$type:Object;ref:test2Model"</span></div><div class="line">}</div><div class="line">  </div><div class="line"><span class="built_in">module</span>.exports = Test1Model;</div></pre></td></tr></table></figure>



<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Test2Model = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">this</span>.$mid = <span class="string">"test2Model"</span>;</div><div class="line">    <span class="keyword">this</span>.$table = <span class="string">"test2"</span>;</div><div class="line">    <span class="keyword">this</span>.id = <span class="string">"$primary;type:Number"</span>;</div><div class="line">}</div><div class="line">  </div><div class="line"><span class="built_in">module</span>.exports = Test2Model;</div></pre></td></tr></table></figure>

<p>通过用 <strong><em>Test1Model.test2</em></strong> 属性，我们使用 <strong><em>ref:test2Model</em></strong> 来设置对 <strong><em>test2Model</em></strong> 的引用  </p>
<h3 id="一对多_relation">一对多 relation</h3>
<p>一对多则意味着，一个model引用着另外一个model数组。比如，我们有一个博客，这个博客里面的文章有很多评论，这个博客文章与评论之间的关系就是一对多的  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Test1Model = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">this</span>.$mid = <span class="string">"test1Model"</span>;</div><div class="line">    <span class="keyword">this</span>.$table = <span class="string">"test1"</span>;</div><div class="line">    <span class="keyword">this</span>.id = <span class="string">"$primary;type:Number"</span>;</div><div class="line">    <span class="keyword">this</span>.test2 = <span class="string">"$type:Array;ref:test2Model"</span></div><div class="line">}</div><div class="line">  </div><div class="line"><span class="built_in">module</span>.exports = Test1Model;</div></pre></td></tr></table></figure>

<p>在上面的model定义中，我们简单的把 <strong><em>test2</em></strong> 属性的 type 改成 <strong><em>Array</em></strong> 即可，它就变成了一对多的关系  </p>
<h3 id="多对多_relation">多对多 relation</h3>
<p>多对多一般可以通过中间表，来转化成两个一对多的关系</p>
<h2 id="SQL_模板">SQL 模板</h2>
<p>当编写复杂sql语句的时候，如果仅仅使用 String 类型的字符串来编写，肯定非常痛苦，更好的方式是用 SQL 模板  </p>
<p>编写SQL模板相当简单    </p>
<p>比如，我们可以定义 id 为 <strong><em>testResultSql</em></strong> 的 SQL 模板  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sql testResultSql</div><div class="line"><span class="operator"><span class="keyword">select</span> * <span class="keyword">from</span> test </span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>

<p>然后我们可以在dao中使用这个 SQL 模板  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">domainDaoSupport.getList(<span class="string">"$testResultSql"</span>, <span class="literal">null</span>, <span class="string">"testModel"</span>, <span class="function"><span class="keyword">function</span><span class="params">(err, results)</span> </span>{</div><div class="line">     <span class="comment">// results is testModel type array</span></div><div class="line">});</div></pre></td></tr></table></figure>

<p>第一个参数，开头带上 $ 就表面是一个 SQL 模板  </p>
<p>同时，由于是模板，因此可以包含其他模板，比如  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">sql testResultSql</div><div class="line"><span class="operator"><span class="keyword">select</span> * <span class="keyword">from</span> ${testResultTable} </span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="keyword">sql</span> testResultTable</div><div class="line">test</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>

<p>这个结果和上面是一样的  </p>
<h2 id="ResultSet_映射">ResultSet 映射</h2>
<p>数据库结果集是一个由field/value对象组成的数组，因此映射结果集就像用特定key/value对来填充对象。为了能够做到匹配，我们使用 model 属性值里的 <strong><em>prefix</em></strong> <a href="http://bearcatjs.org/guide/model.html#model_magic_attribute_value" target="_blank" rel="external">model magic attribute value</a> 或者 model 属性里的 <strong><em>prefix</em></strong> <a href="http://bearcatjs.org/guide/magic-javaScript-objects-in-details.html" target="_blank" rel="external">model attribute</a>  </p>
<p>比如，如果你查询得到了如下的 resultSet  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[{</div><div class="line">	"<span class="attribute">id</span>": <span class="value"><span class="number">1</span></span>,</div><div class="line">	"<span class="attribute">title</span>": <span class="value"><span class="string">"blog_title"</span></span>,</div><div class="line">	"<span class="attribute">content</span>": <span class="value"><span class="string">"blog_content"</span></span>,</div><div class="line">	"<span class="attribute">create_at</span>": <span class="value"><span class="number">1234567</span></span>,</div><div class="line">	"<span class="attribute">update_at</span>": <span class="value"><span class="number">1234567</span></span></div><div class="line">}]</div></pre></td></tr></table></figure>

<p>那么，映射的model就是这样的  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> BlogModel = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">this</span>.$mid = <span class="string">"blogModel"</span>;</div><div class="line">    <span class="keyword">this</span>.$table = <span class="string">"ba_blog"</span>;</div><div class="line">    <span class="keyword">this</span>.id = <span class="string">"$primary;type:Number"</span>;</div><div class="line">    <span class="keyword">this</span>.aid = <span class="string">"$type:Number"</span>;</div><div class="line">    <span class="keyword">this</span>.title = <span class="string">"$type:String"</span>;</div><div class="line">    <span class="keyword">this</span>.content = <span class="string">"$type:String"</span>;</div><div class="line">    <span class="keyword">this</span>.create_at = <span class="string">"$type:Number"</span>;</div><div class="line">    <span class="keyword">this</span>.update_at = <span class="string">"$type:Number"</span>;</div><div class="line">}</div><div class="line">  </div><div class="line"><span class="built_in">module</span>.exports = BlogModel;</div></pre></td></tr></table></figure>

<p>如果结果集字段是已 <strong><em>blog_</em></strong>开头，比如     </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[{</div><div class="line">	"<span class="attribute">blog_id</span>": <span class="value"><span class="number">1</span></span>,</div><div class="line">	"<span class="attribute">blog_title</span>": <span class="value"><span class="string">"blog_title"</span></span>,</div><div class="line">	"<span class="attribute">blog_content</span>": <span class="value"><span class="string">"blog_content"</span></span>,</div><div class="line">	"<span class="attribute">blog_create_at</span>": <span class="value"><span class="number">1234567</span></span>,</div><div class="line">	"<span class="attribute">blog_update_at</span>": <span class="value"><span class="number">1234567</span></span></div><div class="line">}]</div></pre></td></tr></table></figure>

<p>那么，映射model就是这样的  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> BlogModel = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">this</span>.$mid = <span class="string">"blogModel"</span>;</div><div class="line">    <span class="keyword">this</span>.$table = <span class="string">"ba_blog"</span>;</div><div class="line">    <span class="keyword">this</span>.$prefix = <span class="string">"blog_"</span>;</div><div class="line">    <span class="keyword">this</span>.id = <span class="string">"$primary;type:Number"</span>;</div><div class="line">    <span class="keyword">this</span>.aid = <span class="string">"$type:Number"</span>;</div><div class="line">    <span class="keyword">this</span>.title = <span class="string">"$type:String"</span>;</div><div class="line">    <span class="keyword">this</span>.content = <span class="string">"$type:String"</span>;</div><div class="line">    <span class="keyword">this</span>.create_at = <span class="string">"$type:Number"</span>;</div><div class="line">    <span class="keyword">this</span>.update_at = <span class="string">"$type:Number"</span>;</div><div class="line">}</div><div class="line">  </div><div class="line"><span class="built_in">module</span>.exports = BlogModel;</div></pre></td></tr></table></figure>

<p>仅仅需要添加 <strong><em>this.$prefix</em></strong> model 属性  </p>
<h2 id="DAO">DAO</h2>
<p>DAO 是领域对象模型的缩写，一般用于操作数据库  </p>
<p>bearcat-dao 提供 <strong><em>domainDaoSupport</em></strong> 对象，封装了基本的sql、cache操作。使用它也非常简单，直接依赖注入，然后通过 init 方法进行初始化  </p>
<p>simpleDao.js</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> SimpleDao = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">this</span>.$id = <span class="string">"simpleDao"</span>;</div><div class="line">    <span class="keyword">this</span>.$init = <span class="string">"init"</span>;</div><div class="line">    <span class="keyword">this</span>.$domainDaoSupport = <span class="literal">null</span>;</div><div class="line">}</div><div class="line">  </div><div class="line">SimpleDao.prototype.init = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{</div><div class="line">    <span class="comment">// init with SimpleModel id to set up model mapping</span></div><div class="line">    <span class="keyword">this</span>.domainDaoSupport.initConfig(<span class="string">"simpleModel"</span>);</div><div class="line">}</div><div class="line">  </div><div class="line"><span class="comment">// query list all</span></div><div class="line"><span class="comment">// callback return mapped SimpleModel array results</span></div><div class="line">SimpleDao.prototype.getList = <span class="function"><span class="keyword">function</span><span class="params">(cb)</span> </span>{</div><div class="line">    <span class="keyword">var</span> sql = <span class="string">' 1 = 1'</span>;</div><div class="line">    <span class="keyword">this</span>.$domainDaoSupport.getListByWhere(sql, <span class="literal">null</span>, <span class="literal">null</span>, cb);</div><div class="line">}</div><div class="line">  </div><div class="line"><span class="built_in">module</span>.exports = SimpleDao;</div></pre></td></tr></table></figure>

<p>完整的api可以参见 <a href="http://bearcatjs.github.io/bearcat-dao/domainDaoSupport.js.html" target="_blank" rel="external">domainDaoSupport</a></p>
<h2 id="配置使用">配置使用</h2>
<p>修改项目中的context.json<br><a href="https://github.com/bearcatnode/bearcat/wiki/Consistent-configuration" target="_blank" rel="external">placeholds</a> 可以很方便的在不同环境间切换</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">"dependencies": {</div><div class="line">	<span class="string">"bearcat-dao"</span>: <span class="string">"*"</span></div><div class="line">},</div><div class="line">"beans": [{</div><div class="line">	<span class="string">"id"</span>: <span class="string">"mysqlConnectionManager"</span>,</div><div class="line">	<span class="string">"func"</span>: <span class="string">"node_modules.bearcat-dao.lib.connection.sql.mysqlConnectionManager"</span>,</div><div class="line">	<span class="string">"props"</span>: [{</div><div class="line">		<span class="string">"name"</span>: <span class="string">"port"</span>,</div><div class="line">		<span class="string">"value"</span>: <span class="string">"${mysql.port}"</span></div><div class="line">	}, {</div><div class="line">		<span class="string">"name"</span>: <span class="string">"host"</span>,</div><div class="line">		<span class="string">"value"</span>: <span class="string">"${mysql.host}"</span></div><div class="line">	}, {</div><div class="line">		<span class="string">"name"</span>: <span class="string">"user"</span>,</div><div class="line">		<span class="string">"value"</span>: <span class="string">"${mysql.user}"</span></div><div class="line">	}, {</div><div class="line">		<span class="string">"name"</span>: <span class="string">"password"</span>,</div><div class="line">		<span class="string">"value"</span>: <span class="string">"${mysql.password}"</span></div><div class="line">	}, {</div><div class="line">		<span class="string">"name"</span>: <span class="string">"database"</span>,</div><div class="line">		<span class="string">"value"</span>: <span class="string">"${mysql.database}"</span></div><div class="line">	}]</div><div class="line">}, {</div><div class="line">	<span class="string">"id"</span>: <span class="string">"redisConnectionManager"</span>,</div><div class="line">	<span class="string">"func"</span>: <span class="string">"node_modules.bearcat-dao.lib.connection.cache.redisConnectionManager"</span>,</div><div class="line">	<span class="string">"props"</span>: [{</div><div class="line">		<span class="string">"name"</span>: <span class="string">"port"</span>,</div><div class="line">		<span class="string">"value"</span>: <span class="string">"${redis.port}"</span></div><div class="line">	}, {</div><div class="line">		<span class="string">"name"</span>: <span class="string">"host"</span>,</div><div class="line">		<span class="string">"value"</span>: <span class="string">"${redis.host}"</span></div><div class="line">	}]</div><div class="line">}]</div></pre></td></tr></table></figure>

<p>如果你不需要使用redis, 你可以移除<strong><em>redisConnectionManager</em></strong>定义   </p>
<h2 id="事务">事务</h2>
<p>bearcat-dao 基于 <a href="http://bearcatjs.org/guide/aop.html" target="_blank" rel="external">bearcat AOP</a> 提供了事务支持. aspect 是 <a href="https://github.com/bearcatjs/bearcat-dao/blob/master/lib/aspect/transactionAspect.js" target="_blank" rel="external">transactionAspect</a> , 提供了 around advice, 当目标事务方法调用cb函数的时候传入了 <strong><em>err</em></strong>, rollback 回滚操作就会被触发, 相反如果没有cb(err)的话, 事务就会被提交(commit).<br>pointcut 定义的是:  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">"pointcut"</span>: <span class="string">"around:.*?Transaction"</span></div></pre></td></tr></table></figure>


<p>因此, 任何已 <strong><em>Transaction</em></strong> 结尾的POJO中的方法都会匹配到 transaction 事务<br>由于transaction必须在同一个connection中, 在 bearcat-dao 中是通过 <strong><em>transactionStatus</em></strong> 来保证的, 在同一个事务的 transaction 必须在同一个transactionStatus中  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">SimpleService.prototype.testMethodTransaction = <span class="function"><span class="keyword">function</span><span class="params">(cb, txStatus)</span> </span>{</div><div class="line">	<span class="keyword">var</span> self = <span class="keyword">this</span>;</div><div class="line">	<span class="keyword">this</span>.simpleDao.transaction(txStatus).addPerson([<span class="string">'aaa'</span>], <span class="function"><span class="keyword">function</span><span class="params">(err, results)</span> </span>{</div><div class="line">		<span class="keyword">if</span> (err) {</div><div class="line">			<span class="keyword">return</span> cb(err); <span class="comment">// if err occur, rollback will be emited</span></div><div class="line">		}</div><div class="line">		self.simpleDao.transaction(txStatus).getList([<span class="number">1</span>, <span class="number">2</span>], <span class="function"><span class="keyword">function</span><span class="params">(err, results)</span> </span>{</div><div class="line">			<span class="keyword">if</span> (err) { </div><div class="line">				<span class="keyword">return</span> cb(err); <span class="comment">// if err occur, rollback will be emited</span></div><div class="line">			}</div><div class="line">			cb(<span class="literal">null</span>, results); <span class="comment">// commit the operations</span></div><div class="line">		});</div><div class="line">	});</div><div class="line">}</div></pre></td></tr></table></figure>

<h2 id="开启_Debug_模式">开启 Debug 模式</h2>
<p>跑node应用时带上BEARCAT_DEBUG为true</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="constant">BEARCAT_DEBUG</span>=<span class="literal">true</span> node xxx.js</div></pre></td></tr></table></figure>

<p>开启debug模式后，就能看到具体执行SQL的日志  </p>
<h2 id="例子">例子</h2>
<ul>
<li><a href="https://github.com/bearcatnode/todo" target="_blank" rel="external">bearcat-todo</a> </li>
<li><a href="https://github.com/bearcatjs/bearcat-examples/tree/master/bearcat-dao-example" target="_blank" rel="external">bearcat-dao example</a></li>
</ul>

    
    <div id="disqus_thread"></div>
	<script type="text/javascript">
	    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
	    var disqus_shortname = 'bearcatjs'; // required: replace example with your forum shortname

	    /* * * DON'T EDIT BELOW THIS LINE * * */
	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();
	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    
    <div class="footer">Caught a mistake or want to contribute to the documentation? <a href="https://github.com/bearcatjs/bearcatjs.org" target="_blank">Fork this site on Github</a>!</div>
</div>
            
        </div>

        
            <script src="/js/smooth-scroll.min.js"></script>
            <script src="/js/common.js"></script>
        

    </body>
</html>